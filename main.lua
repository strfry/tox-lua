local toxcore = require "toxcore"
--local sodium = require "ffi".load("sodium")
local bindechex = require "BinDecHex"

function string.fromhex(str)
    return (str:gsub('..', function (cc)
        return string.char(tonumber(cc, 16))
    end))
end

bootnodes = {
    {"192.210.149.121", 33445, "F404ABAA1C99A9D37D61AB54898F56793E1DEF8BD46B1038B9D822E8460FAB67", {0}},
    {"tox.zodiaclabs.org",         33445, "A09162D68618E742FFBCA1C2C70385E6679604B2D80EA6E84AD0996A1AC8A074", {0}},
    {"node.tox.biribiri.org",      33445, "F404ABAA1C99A9D37D61AB54898F56793E1DEF8BD46B1038B9D822E8460FAB67", {0}},
    {"178.62.250.138",             33445, "788236D34978D1D5BD822F0A5BEBD2C53C64CC31CD3149350EE27D4D9A2F9B6B", {0}},
    {"2a03:b0c0:2:d0::16:1",       33445, "788236D34978D1D5BD822F0A5BEBD2C53C64CC31CD3149350EE27D4D9A2F9B6B", {0}},
    {"163.172.136.118",            33445, "2C289F9F37C20D09DA83565588BF496FAB3764853FA38141817A72E3F18ACA0B", {0}},
}

tox = toxcore(nil)

print ("Created Tox object: ", tox)

tox:self_set_status_message("Tox Lua Bot", 0, nil)

function self_connection_status_cb(tox, status, _)
    print ("Connection Status changed to", status)
end

tox:callback_self_connection_status(self_connection_status_cb)

for _,v in pairs(bootnodes) do
    local binkey = v[3]:fromhex()
    tox:bootstrap(v[1], v[2], binkey, nil)
    print (string.format("Adding bootnode %s:%d",v[1], v[2]))
end

jit.off()
--jit.off(self_connection_status_cb)
--jit.off(toxcore.tox_iterate)

while true do
    tox:iterate(nil)
end
